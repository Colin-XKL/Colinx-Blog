---
title: å‰ç«¯é™æ€èµ„æºåŠ è½½çš„ä¸€äº›ä¼˜åŒ–
date: 2022-05-06
description: æœ€è¿‘åœ¨æŠ˜è…¾ä¼˜åŒ–åšå®¢ï¼Œç”±äºå…¨ç«™éƒ½æ˜¯éƒ¨ç½²åœ¨Netlifyã€Vercelçš„CDNä¸Šï¼Œéƒ½æ˜¯æµ·å¤–èŠ‚ç‚¹ï¼Œå›½å†…è®¿é—®å»¶è¿Ÿé«˜ï¼Œåœ¨æƒ³åŠæ³•ä¼˜åŒ–ä¸‹è®¿é—®é€Ÿåº¦å’Œä½“éªŒã€‚è¿™ç¯‡æ–‡ç« æ¥æ¢è®¨ä¸‹å‰ç«¯CSSå’ŒJSèµ„æºçš„åŠ è½½ã€‚ä¼˜åŒ–ç›®æ ‡ä¸»è¦å°±ä¸¤ä¸ªï¼š1. å°½å¯èƒ½å¿«ï¼Œä½†æ˜¯ä¸å¸Œæœ›æˆ‘å¼•å…¥çš„è¾…åŠ©æ€§ç¬¬ä¸‰æ–¹åº“å½±å“åˆ°é¡µé¢ä½“éªŒï¼Œä¸è¦é˜»å¡ä¸»è¦å†…å®¹æ¸²æŸ“.  2. ä¸ºäº†å¿«ç¬¬ä¸‰æ–¹é™æ€èµ„æºè‚¯å®šæ˜¯ä¸ŠCDNï¼Œä½†æ˜¯è¦æœ‰å®¹ç¾ï¼ŒCDNæŒ‚äº†è¦èƒ½fallbackåˆ°å…¶ä»–url
categories:
- æŠ€æœ¯
tags:
- æŠ€æœ¯
- å‰ç«¯
- CDN
- JavaScript
---

<!-- # å‰ç«¯é™æ€èµ„æºåŠ è½½çš„ä¸€äº›ä¼˜åŒ– -->

æœ€è¿‘åœ¨æŠ˜è…¾ä¼˜åŒ–åšå®¢ï¼Œç”±äºå…¨ç«™éƒ½æ˜¯éƒ¨ç½²åœ¨Netlifyã€Vercelçš„CDNä¸Šï¼Œéƒ½æ˜¯æµ·å¤–èŠ‚ç‚¹ï¼Œå›½å†…è®¿é—®å»¶è¿Ÿé«˜ï¼Œåœ¨æƒ³åŠæ³•ä¼˜åŒ–ä¸‹è®¿é—®é€Ÿåº¦å’Œä½“éªŒã€‚çº¿è·¯éƒ¨åˆ†çš„ä¼˜åŒ–å¯ä»¥çœ‹å¦ä¸€ç¯‡æ–‡ç« [å›½å¤–é™æ€ç½‘ç«™æ‰˜ç®¡æœåŠ¡å•†å›½å†…é€Ÿåº¦å¯¹æ¯”åŠçº¿è·¯ä¼˜åŒ–](https://blog.colinx.one/posts/%E5%9B%BD%E5%A4%96%E9%9D%99%E6%80%81%E7%BD%91%E7%AB%99%E6%89%98%E7%AE%A1%E5%9C%A8%E5%9B%BD%E5%86%85%E9%80%9F%E5%BA%A6%E5%AF%B9%E6%AF%94%E5%8F%8A%E7%BA%BF%E8%B7%AF%E4%BC%98%E5%8C%96/)ã€‚è¿™ç¯‡æ–‡ç« æ¥æ¢è®¨ä¸‹å‰ç«¯CSSå’ŒJSèµ„æºçš„åŠ è½½ã€‚

ä¼˜åŒ–ç›®æ ‡ä¸»è¦å°±ä¸¤ä¸ªï¼š

* å°½å¯èƒ½å¿«ï¼Œä½†æ˜¯ä¸å¸Œæœ›æˆ‘å¼•å…¥çš„è¾…åŠ©æ€§ç¬¬ä¸‰æ–¹åº“å½±å“åˆ°é¡µé¢ä½“éªŒï¼Œä¸è¦é˜»å¡ä¸»è¦å†…å®¹æ¸²æŸ“
* ä¸ºäº†å¿«ç¬¬ä¸‰æ–¹é™æ€èµ„æºè‚¯å®šæ˜¯ä¸ŠCDNï¼Œä½†æ˜¯è¦æœ‰å®¹ç¾ï¼ŒCDNæŒ‚äº†è¦èƒ½fallbackåˆ°å…¶ä»–url



## é™æ€èµ„æºå¼‚æ­¥åŠ è½½

`prefetch`ã€`preload`è¿™äº›é¢„åŠ è½½æŠ€æœ¯æš‚ä¸”ä¸è°ˆï¼Œåšå®¢ç«™ç‚¹æ²¡é‚£ä¹ˆå¤šèµ„æºã€‚è¿™é‡Œä¸»è¦æ˜¯ç”¨`async`å’Œ`defer`æ¥æ§åˆ¶è„šæœ¬å¼‚æ­¥åŠ è½½ï¼Œä»¥é¿å…é˜»å¡DOMè§£æå’Œé¡µé¢æ¸²æŸ“ã€‚

ä½¿ç”¨`async`å¼‚æ­¥åŠ è½½ï¼Œå¯¹äº[pangu](https://github.com/vinta/pangu.js/)è¿™ç§ä¼šå½±å“åˆ°å†…å®¹å‘ˆç°çš„ä½¿ç”¨`async`ï¼Œå¯¹äºç»Ÿè®¡ç±»ç¬¬ä¸‰æ–¹åº“ä½¿ç”¨`defer`å»¶è¿ŸåŠ è½½ï¼Œåˆ°DOMåŠ è½½å®Œå†æ‰§è¡Œ

æœ‰äº›ç¬¬ä¸‰æ–¹åº“éœ€è¦æ‰‹åŠ¨initï¼Œè¿™æ ·å°±ä¸èƒ½ä½¿ç”¨`defer`ã€`async`å…³é”®å­—åŠ è½½èµ„æºäº†ï¼Œ**`defer`å’Œ`async`å…³é”®å­—åªé€‚ç”¨äºè¿œç¨‹èµ„æº**ï¼Œæœ¬ä»¥ä¸ºæŠŠè¿œç¨‹èµ„æºçš„`<script>`å’Œå†…åµŒåœ¨HTMLé‡Œç”¨æ¥initçš„`<script>`éƒ½åŠ ä¸Š`defer`å°±å¯ä»¥åˆ©ç”¨å®ƒé¡ºåºåŠ è½½çš„ç‰¹æ€§è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç»“æœå‘ç°ä¸æ˜¯è¿™æ ·çš„ã€‚ã€‚ã€‚ã€‚å¼‚æ­¥æ‰“ä¹±è„šæœ¬æ‰§è¡Œé¡ºåºï¼Œinitè„šæœ¬ä¸ç­‰å¾…èµ„æºä¸‹è½½å®Œæ¯•ä¼šå…ˆæ‰§è¡Œã€‚åˆ©ç”¨å¥½`onload`äº‹ä»¶å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

before

```html
<script src="https://cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
<script>
    pangu.spacingElementByClassName('post');
    pangu.spacingElementByTagName('p');

    document.addEventListener('DOMContentLoaded', () => {
        pangu.autoSpacingPage();
    });
</script>
```



after

```html
<script>
    function panguSpaing() {
        pangu.spacingElementByClassName('post');
        pangu.spacingElementByTagName('p');

        document.addEventListener('DOMContentLoaded', () => {
            // listen to any DOM change and automatically perform spacing via MutationObserver()
            pangu.autoSpacingPage();
        });
    }
</script>
<script async onload="panguSpaing()" src="https://cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
```



é™¤äº†`onload`è¿˜æœ‰`onerror`ï¼Œè¿˜å¯ä»¥åˆ©ç”¨`onerror`äº‹ä»¶åœ¨èµ„æºåŠ è½½å¤±è´¥æ—¶fallbackåˆ°å…¶ä»–CDNï¼Œè¯¦è§ä¸‹æ–‡

è¿™é‡Œè·‘äº†ä¸ªæµ‹è¯•çœ‹ä¸‹ä¼˜åŒ–å‰åçš„å·®è·

**ä¼˜åŒ–å‰**

![image-20220506193639029](https://blog-1301127393.file.myqcloud.com/BlogImgs/202205062117479.png)

![image-20220506193800266](https://blog-1301127393.file.myqcloud.com/BlogImgs/202205062117127.png)

First Contentful Pain Timeåœ¨1.5sï¼Œæ•´ä¸ªé¡µé¢åˆ°1.5sæ‰èƒ½å¯è§ï¼ŒDOMåŠ è½½æ€»æ—¶é—´è¾¾åˆ°äº†2.5s

æœ¬æ¥æˆ‘éƒ½å·²ç»æŠŠé¦–é¡µä¸éœ€è¦åŠ è½½çš„ä¸‰æ–¹åº“éƒ½æ‹¿èµ°äº†ï¼Œä½†æ˜¯è¿˜å‰©ä¸‹ä¸€ä¸ªï¼Œè¿™ä¸ªç”¨äºå‰ç«¯æ€§èƒ½ç›‘æ§çš„jsé˜»å¡äº†æ¸²æŸ“ï¼ŒæŒ‚çš„æ˜¯è…¾è®¯äº‘çš„CDNï¼Œå›½å†…å¿«åˆ°é£èµ·ï¼Œå›½å¤–å°±å¡åˆ°ä¸è¡Œï¼ˆä½œä¸ºå¯¹æ¯”ä¸Šå›¾é‡Œä»jsdelivråŠ è½½çš„jsä¹Ÿæ˜¯å¿«åˆ°é£èµ·ï¼Œå¢™å†…å°±æ…¢å¾—ä¸€æ‰¹ï¼‰

**ä¼˜åŒ–å**

![image-20220506193652188](https://blog-1301127393.file.myqcloud.com/BlogImgs/202205062117498.png)

ä¼˜åŒ–åé¡µé¢æ²¡æœ‰å†é˜»å¡ï¼Œ0.8sé¡µé¢å°±å¯ç”¨äº†ï¼Œæ€»DOMåŠ è½½æ—¶é—´åªæœ‰1.5sï¼Œç›¸è¾ƒä¹‹å‰ç®€ç›´ç›´æ¥èµ·é£ã€‚


![cn](https://blog-1301127393.cos.ap-shanghai.myqcloud.com/BlogImgs/202205071426038.png)  

å›½å†…æŸæ£€æµ‹å¹³å°çš„ç»“æœä¹Ÿæ˜¾ç¤ºä¼˜åŒ–æ•ˆæœæ˜æ˜¾

## é™æ€èµ„æºFallbackåŠ è½½

å›½å†…å¥½ç”¨çš„é™æ€èµ„æºCDNè¿˜çœŸæ²¡æœ‰ï¼Œæ–°æµªé‚£ç§åªæä¾›é‚£ä¹ˆå‡ ä¸ªçƒ­é—¨çš„åº“å®Œå…¨ä¸ç¬¦åˆéœ€æ±‚ï¼ŒBootCDNç‚¸äº†ä¸æ˜¯ä¸€æ¬¡ä¸¤æ¬¡ï¼Œå­—èŠ‚CDNçš„èµ„æºURLæœ‰å¤Ÿuglyï¼ŒURLé‡Œé¢è¿˜å¸¦èŠ‚ç‚¹ä¿¡æ¯å¤šåŠåé¢ä¼šå‡ºé—®é¢˜ã€‚360å¥‡èˆCDNä¹‹å‰ä¹Ÿæ¢è¿‡åŸŸåã€å¤‡æ¡ˆå‡ºé—®é¢˜ï¼Œæ„Ÿè§‰æ¯ä¸€ä¸ªèƒ½çœå¿ƒç”¨ã€‚ä¸ƒç‰›çš„ç›®å‰çœ‹ä¸Šå»è¿˜è¡Œï¼Œä¹Ÿä¸çŸ¥é“åé¢ä¼šä¸ä¼šå‡ºä»€ä¹ˆå¹ºè›¾å­ã€‚ã€‚ã€‚ä¸ºäº†ç¨³å¦¥èµ·è§+ç…§é¡¾å…¨çƒçš„è®¿å®¢ï¼Œè¿˜æ˜¯ä¼˜å…ˆä½¿ç”¨çš„cloudflareå’Œjsdelivrçš„CDN

ç½‘ç«™ä¸»è¦ä¸‰æ–¹åº“éƒ½æ˜¯é€šè¿‡jsdelivrå’Œcloudflareå¼•å…¥çš„ï¼Œä½†æ˜¯æ¯•ç«Ÿæ˜¯æµ·å¤–çš„èŠ‚ç‚¹ä¸çŸ¥é“å“ªä¸€å¤©å°±è¢«å¢™äº†ï¼Œæ‰€ä»¥è¿˜è¦ä¸ºå¢™å†…çš„è®¿å®¢å‡†å¤‡ä¸€ä¸ªfallbackæ–¹æ¡ˆã€‚è¿™é‡Œåˆ©ç”¨åˆ°`script`æ ‡ç­¾çš„`onerror`äº‹ä»¶



ç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒ`script`å’Œ`link`æ ‡ç­¾ä¸Šçš„`onload`å’Œ`onerror`äº‹ä»¶ï¼Œè¯¦ç»†æ”¯æŒæƒ…å†µå¯ä»¥æŸ¥çœ‹è¿™é‡Œ

[https://pie.gd/test/script-link-events/](https://pie.gd/test/script-link-events/)



å…³äº`onerror`ï¼Œä¸­æ–‡äº’è”ç½‘ä¸Šæœ‰å¥½å‡ ç¯‡æ–‡ç« è¯´ä»–ä¼šæ•è·`script`æ ‡ç­¾é‡Œçš„ä»£ç çš„æ‰§è¡Œé”™è¯¯ã€‚ã€‚ã€‚ç®€ç›´ç¦»è°±ã€‚ç¨å¾®æŸ¥ä¸‹MDNä¹‹ç±»çš„æ–‡æ¡£å°±å¯ä»¥å‘ç°è¿™ç©æ„æœ¬æ¥å°±æ˜¯åªæ•è·èµ„æºåŠ è½½é”™è¯¯çš„

> The onerror event is triggered if an error occurs while loading an external file (e.g. a document or an image).
>
> https://www.w3schools.com/jsref/event_onerror.asp



åˆ©ç”¨å¥½è¿™ä¸ªç‰¹æ€§ï¼Œå°±å¯ä»¥å®ç°åœ¨èµ„æºåŠ è½½å¤±è´¥æ—¶fallbackä»å¦ä¸€ä¸ªurlåŠ è½½èµ„æºã€‚

```html
<script>
    function fallbackJSloader(url, loadedEvent) {
        console.log('Error loading asset, using fallback url');
        console.log('load asset from', url);

        let script = document.createElement("script");
        script.type = "text/javascript";
        script.src = url;
        script.async = true;
        if (loadedEvent)
            script.setAttribute('onload', `${loadedEvent}()`)
        document.body.appendChild(script);
    }
</script>

<script defer onload="init_gitalk()"
onerror="fallbackJSloader('https://cdn.staticfile.org/gitalk/1.7.2/gitalk.min.js','init_gitalk')"
src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js">
```

CSSçš„fallbackåŠ è½½åŒç†ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°

ä¼˜åŒ–åå¦‚å›¾ï¼Œåœ¨å¼€å‘è€…å·¥å…·ä¸­æ‰‹åŠ¨blockèµ„æºç½‘ç«™ï¼Œå¯ä»¥è‡ªåŠ¨fallbackä»å¦ä¸€ä¸ªurlåŠ è½½èµ„æºï¼Œè¿™ä¸‹ç½‘ç«™çš„å¯ç”¨æ€§åˆæå‡äº†ä¸€ç‚¹ç‚¹ğŸ¤å“ˆå“ˆå“ˆ

![66230832-3581-42DF-9F2F-B817E88DAF4D](https://blog-1301127393.file.myqcloud.com/BlogImgs/202205062133393.png)



## æ‰©å±•é˜…è¯»

* [æ¶ˆé™¤é˜»å¡é¡µé¢æ¸²æŸ“çš„èµ„æº](https://www.w3cplus.com/performance/remove-block-rendering.html)
* [defer å’Œ async çš„åŒºåˆ«](https://segmentfault.com/q/1010000000640869)
* [åŠ¨æ€åŠ è½½ css](http://lengyun.github.io/js/3-2-2dynamicAddCSS.html#%E4%B8%8E%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BDjs%E7%9A%84%E5%8C%BA%E5%88%AB)

**ç½‘ç«™profile**å·¥å…·

* [https://www.webpagetest.org](https://www.webpagetest.org)